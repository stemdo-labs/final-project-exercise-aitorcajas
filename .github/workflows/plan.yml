name: terraform plan

on:
 pull_request:
  branches:
  - main

permissions: 
  pull-requests: write
  contents: read
  issues: write

jobs:
 plan:
  runs-on: runner-stemdo-labs
  steps:
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
        node-version: '20'

  - uses: actions/checkout@v3

  - name: 'Terraform Init'
    uses: hashicorp/terraform-github-actions@master
    with:
      tf_actions_version: ${{ env.TF_VERSION }}
      tf_actions_subcommand: 'init'
      tf_actions_working_dir: "./iac"

  - name: 'Terraform Plan'
    id: tf_plan
    uses: hashicorp/terraform-github-actions@master
    with:
      tf_actions_version: ${{ env.TF_VERSION }}
      tf_actions_subcommand: 'plan'
      tf_actions_working_dir: "./iac"

  - name: 'Comentar resultado del Terraform Plan'
    if: github.event_name == 'pull_request'
    uses: actions/github-script@v6
    with:
     script: |
      const planOutput = `\`\`\`\n${{ steps.tf_plan.outputs.tf_actions_plan_output }}\n\`\`\``;
      github.rest.issues.createComment({
       issue_number: context.issue.number,
       owner: context.repo.owner,
       repo: context.repo.repo,
       body: `### Resultado del Terraform Plan:\n${planOutput}`
      });