name: Subir charts de Helm

on:
  workflow_dispatch:
    
jobs:
  subir:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Comprimir charts
        run: |
          helm package ./backend/
          helm package ./frontend/
        working-directory: charts

      - name: Version del backend
        id: back_version
        run: |
          ls
          VERSION=$(grep "^version:" ./backend/Chart.yaml | awk '{print $2}')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "back_version=$VERSION" >> $GITHUB_OUTPUT
        working-directory: charts

      - name: Version del frontend
        id: front_version
        run: |
          VERSION=$(grep "^version:" ./frontend/Chart.yaml | awk '{print $2}')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "front_version=$VERSION" >> $GITHUB_OUTPUT
        working-directory: charts

      - name: Mostrar
        run: |
          echo "BACKEND: ${{steps.back_version.outputs.back_version}}"
          echo "FRONTEND: ${{steps.front_version.outputs.front_version}}"

      - name: Push Chart backend
        run: |
          helm push backend-${{steps.back_version.outputs.back_version}}.tgz https://harbor.codeops.es/harbor/projects/2/repositories
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USER }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASS }}
        working-directory: charts     

      - name: Push Chart frontend
        run: |
          helm push frontend-${{steps.front_version.outputs.front_version}}.tgz oci://core.harbor.domain/acajas
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USER }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASS }} 
        working-directory: charts