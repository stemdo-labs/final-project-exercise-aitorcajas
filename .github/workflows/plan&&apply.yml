name: terraform plan && apply

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

env:
  TF_VERSION: 1.5.7
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

permissions: 
  pull-requests: write
  contents: read
  issues: write

jobs:
 plan:
  if: github.event_name == 'pull_request'
  runs-on: ubuntu-latest
  steps:
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
        node-version: '20'

  - uses: actions/checkout@v3

  - name: Setup Terraform
    uses: hashicorp/setup-terraform@v2
    with:
      terraform_version: ${{ env.TF_VERSION }}

  - name: Initialize Terraform
    run: terraform init
    working-directory: ./iac
    
  - name: Terraform Plan
    id: tf_plan
    run: | 
     terraform plan -auto-approve
    working-directory: ./iac

  - name: 'Comentar resultado del Terraform Plan'
    if: github.event_name == 'pull_request'
    uses: actions/github-script@v6
    with:
     script: |
      const planOutput = `\`\`\`\n${{ steps.tf_plan.outputs.tf_actions_plan_output }}\n\`\`\``;
      github.rest.issues.createComment({
       issue_number: context.issue.number,
       owner: context.repo.owner,
       repo: context.repo.repo,
       body: `### Resultado del Terraform Plan:\n${planOutput}`
      });

 apply:
  if: github.event_name == 'push'
  runs-on: ubuntu-latest
  steps:
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'

  - uses: actions/checkout@v3

  - name: Setup Terraform
    uses: hashicorp/setup-terraform@v2
    with:
      terraform_version: ${{ env.TF_VERSION }}

  - name: Initialize Terraform
    run: terraform init
    working-directory: ./iac
    
  - name: Terraform Apply
    run: | 
     terraform apply -auto-approve
    working-directory: ./iac